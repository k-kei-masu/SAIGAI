<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- ä¿®æ­£1: viewport ã‚’ç«¯æœ«å¹…ï¼†ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢å¯¾å¿œã« -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¨˜éŒ²</title>
    <style>
        :root {
            /* ä¿®æ­£2: ãƒœãƒˆãƒ ãƒŠãƒ“ã®é«˜ã•ã‚’å¤‰æ•°åŒ–ã—ã¦ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å´ã®ä¸‹ä½™ç™½ã«åæ˜  */
            --navH: 72px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            /* ä¿®æ­£3: iOS ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¯¾ç­–ã§ 100vh ã§ã¯ãªã 100dvh ã‚’ä½¿ç”¨ */
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            /* ç”»é¢å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯æŠ‘æ­¢ã—ã€å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«ä¸€æœ¬åŒ– */
            overflow: hidden;
            position: relative;
        }

        .app-container {
            /* ä¿®æ­£4: flex å­è¦ç´ ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ã™ã‚‹ãŸã‚ min-height:0 ã‚’ä»˜ä¸ */
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            min-height: 0;
        }

        .content {
            /* ä¿®æ­£5: å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®æœ‰åŠ¹åŒ–ï¼ˆiOS ã§å¿…é ˆï¼‰ */
            flex: 1 1 auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            /* ä¿®æ­£6: ãƒœãƒˆãƒ ãƒŠãƒ“ï¼‹ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢åˆ†ã®ä¸‹ä½™ç™½ã‚’å¸¸æ™‚ç¢ºä¿ */
            padding-bottom: calc(var(--navH) + 16px + env(safe-area-inset-bottom));
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ã®è¦ªã§é«˜ã•åˆ¶ç´„ãŒã‹ã‹ã‚‰ãªã„ã‚ˆã†ã« */
            min-height: 0;
        }

        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Tab */
        .status-display {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin: 20px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .current-status { font-size: 28px; font-weight: bold; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .elapsed-time { font-size: 18px; opacity: 0.9; }

        .status-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 20px;
        }

        .status-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            position: relative;
            overflow: hidden;
        }

        .status-btn::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }
        .status-btn:active::before { width: 300px; height: 300px; }
        .status-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
        .status-btn.locked { opacity: 0.5; cursor: not-allowed; }
        .status-btn.é€€ç¤¾ { background: rgba(255, 100, 100, 0.3); border-color: rgba(255, 100, 100, 0.5); }

        .photo-add-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin: 0 20px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .photo-add-btn:hover { background: rgba(255, 255, 255, 0.3); }

        /* Timeline Tab */
        .date-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .date-nav button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .date-nav button:hover { background: rgba(255, 255, 255, 0.3); }

        .timeline-list { padding: 20px; }
        .timeline-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(5px);
            position: relative;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .timeline-card .status-badge { display: inline-block; background: rgba(255, 255, 255, 0.3); padding: 5px 15px; border-radius: 20px; font-weight: bold; margin-bottom: 10px; }
        .timeline-card .time-info { font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
        .timeline-card .edit-btn { position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.2); border: none; color: #fff; padding: 5px 10px; border-radius: 5px; cursor: pointer; }

        /* Photos Tab */
        .photo-tabs {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            position: sticky; top: 0; z-index: 10;
        }
        .photo-tab { padding: 10px 20px; background: rgba(255, 255, 255, 0.1); border: none; color: #fff; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; }
        .photo-tab.active { background: rgba(255, 255, 255, 0.3); }
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px; }
        .photo-item { aspect-ratio: 1; background: rgba(255, 255, 255, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; overflow: hidden; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-item.add-photo { border: 2px dashed rgba(255, 255, 255, 0.5); }
        .photo-item:hover { transform: scale(1.05); }

        /* Settings Tab */
        .settings-list { padding: 20px; }
        .setting-item { background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .setting-label { font-size: 16px; }
        .toggle { position: relative; width: 50px; height: 28px; background: rgba(255, 255, 255, 0.3); border-radius: 14px; cursor: pointer; transition: all 0.3s ease; }
        .toggle.active { background: #4CAF50; }
        .toggle::after { content: ''; position: absolute; width: 24px; height: 24px; background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: all 0.3s ease; }
        .toggle.active::after { left: 24px; }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; align-items: center;
            height: var(--navH);
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 5px 15px; transition: all 0.3s ease; opacity: 0.6; }
        .nav-item.active { opacity: 1; }
        .nav-icon { font-size: 24px; margin-bottom: 5px; }
        .nav-label { font-size: 12px; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); z-index: 1000; animation: fadeIn 0.3s ease; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 30px; width: 90%; max-width: 350px; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-title { font-size: 20px; margin-bottom: 20px; text-align: center; }
        .time-input { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: #fff; padding: 10px; border-radius: 10px; width: 100%; margin-bottom: 15px; font-size: 16px; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; transition: all 0.3s ease; }
        .modal-btn.save { background: rgba(76, 175, 80, 0.8); color: #fff; }
        .modal-btn.cancel { background: rgba(255, 255, 255, 0.2); color: #fff; }

        /* Toast */
        .toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            bottom: calc(var(--navH) + 16px + env(safe-area-inset-bottom));
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 15px 25px;
            border-radius: 25px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.undo { background: rgba(33, 150, 243, 0.9); cursor: pointer; }

        /* Loading */
        .loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3000; }
        .spinner { width: 50px; height: 50px; border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

        input[type="file"] { display: none; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="content">
            <!-- Home Tab -->
            <div id="home-tab" class="tab-content active">
                <div class="status-display">
                    <div class="current-status" id="current-status">å¾…æ©Ÿä¸­</div>
                    <div class="elapsed-time" id="elapsed-time">00:00:00</div>
                </div>

                <div class="status-buttons">
                    <button class="status-btn" data-status="å‡ºç¤¾">ğŸ“¥ å‡ºç¤¾</button>
                    <button class="status-btn é€€ç¤¾" data-status="é€€ç¤¾">ğŸ“¤ é€€ç¤¾</button>
                    <button class="status-btn" data-status="ä½œæ¥­">ğŸ”§ ä½œæ¥­</button>
                    <button class="status-btn" data-status="å¾…æ©Ÿ">â¸ï¸ å¾…æ©Ÿ</button>
                    <button class="status-btn" data-status="ç§»å‹•">ğŸš¶ ç§»å‹•</button>
                    <button class="status-btn" data-status="ä¼‘æ†©">â˜• ä¼‘æ†©</button>
                </div>

                <div class="photo-add-btn" onclick="app.addPhoto()">ğŸ“· å†™çœŸã‚’è¿½åŠ </div>

                <div class="timeline-list" id="recent-timeline"><!-- Recent timeline items --></div>
            </div>

            <!-- Timeline Tab -->
            <div id="timeline-tab" class="tab-content">
                <div class="date-nav">
                    <button onclick="app.changeDate(-1)">â—€ å‰æ—¥</button>
                    <span id="current-date">2025-08-18</span>
                    <button onclick="app.changeDate(1)">ç¿Œæ—¥ â–¶</button>
                </div>
                <div class="timeline-list" id="timeline-list"><!-- Timeline cards --></div>
            </div>

            <!-- Photos Tab -->
            <div id="photos-tab" class="tab-content">
                <div class="photo-tabs">
                    <button class="photo-tab active" data-status="ä½œæ¥­">ä½œæ¥­</button>
                    <button class="photo-tab" data-status="å¾…æ©Ÿ">å¾…æ©Ÿ</button>
                    <button class="photo-tab" data-status="ç§»å‹•">ç§»å‹•</button>
                    <button class="photo-tab" data-status="ä¼‘æ†©">ä¼‘æ†©</button>
                </div>
                <div class="photo-grid" id="photo-grid"><!-- Photo items --></div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="settings-list">
                    <div class="setting-item">
                        <span class="setting-label">ğŸ“ ä½ç½®æƒ…å ±ã®é€ä¿¡</span>
                        <div class="toggle active" data-setting="consent_location"></div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">ğŸ”” é€šçŸ¥</span>
                        <div class="toggle active" data-setting="notify"></div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">ğŸš¶ è‡ªå‹•ç§»å‹•æ¤œçŸ¥</span>
                        <div class="toggle" data-setting="auto_move_detect"></div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">ğŸ“¡ é€ä¿¡çŠ¶æ³</span>
                        <span id="send-status">å¾…æ©Ÿ: 0 / é€ä¿¡æ¸ˆ: 0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" data-tab="home">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">Home</span>
            </div>
            <div class="nav-item" data-tab="timeline">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-label">Timeline</span>
            </div>
            <div class="nav-item" data-tab="photos">
                <span class="nav-icon">ğŸ“¸</span>
                <span class="nav-label">Photos</span>
            </div>
            <div class="nav-item" data-tab="settings">
                <span class="nav-icon">âš™ï¸</span>
                <span class="nav-label">Settings</span>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-title">æ™‚åˆ»ã‚’ç·¨é›†</div>
            <input type="datetime-local" class="time-input" id="start-time-input">
            <input type="datetime-local" class="time-input" id="end-time-input">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="app.closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-btn save" onclick="app.saveTimeEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Loading -->
    <div class="loading" id="loading"><div class="spinner"></div></div>

    <!-- Hidden file input -->
    <input type="file" id="photo-input" accept="image/*" multiple onchange="app.handlePhotoUpload(event)">

    <script>
        const app = {
            data: {
                user: { id: "u-001", name: "ç­å“¡A", team_id: "t-01" },
                settings: { consent_location: true, notify: true, auto_move_detect: false },
                timeline: [],
                photos: { "ä½œæ¥­": [], "å¾…æ©Ÿ": [], "ç§»å‹•": [], "ä¼‘æ†©": [] },
                queue: { pending: 0, sent: 0 }
            },
            currentStatus: null,
            currentSegment: null,
            statusStartTime: null,
            currentDate: new Date().toISOString().split('T')[0],
            autoMoveInterval: null,
            lastAction: null,
            buttonLocked: false,
            longPressTimer: null,
            currentPhotoStatus: 'ä½œæ¥­',
            editingSegment: null,

            init() {
                this.loadData();
                this.setupEventListeners();
                this.updateUI();
                this.startElapsedTimer();
                if (this.data.settings.auto_move_detect) this.startAutoMove();
            },

            loadData() {
                const saved = localStorage.getItem('timelineData');
                if (saved) this.data = JSON.parse(saved);
            },
            saveData() { localStorage.setItem('timelineData', JSON.stringify(this.data)); },

            setupEventListeners() {
                // Navigation tabs
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => this.switchTab(item.dataset.tab));
                });

                // Status buttons
                document.querySelectorAll('.status-btn').forEach(btn => {
                    const status = btn.dataset.status;
                    if (status === 'é€€ç¤¾') {
                        btn.addEventListener('mousedown', () => this.startLongPress(status));
                        btn.addEventListener('mouseup', () => this.endLongPress());
                        btn.addEventListener('mouseleave', () => this.endLongPress());
                        btn.addEventListener('touchstart', (e) => { e.preventDefault(); this.startLongPress(status); }, { passive: false });
                        btn.addEventListener('touchend', (e) => { e.preventDefault(); this.endLongPress(); }, { passive: false });
                    } else {
                        btn.addEventListener('click', () => this.changeStatus(status));
                    }
                });

                // Settings toggles
                document.querySelectorAll('.toggle').forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        const setting = toggle.dataset.setting;
                        toggle.classList.toggle('active');
                        this.data.settings[setting] = toggle.classList.contains('active');
                        if (setting === 'auto_move_detect') {
                            this.data.settings.auto_move_detect ? this.startAutoMove() : this.stopAutoMove();
                        }
                        this.saveData();
                    });
                });

                // Photo tabs
                document.querySelectorAll('.photo-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.photo-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.currentPhotoStatus = tab.dataset.status;
                        this.updatePhotoGrid();
                    });
                });
            },

            switchTab(tab) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`${tab}-tab`).classList.add('active');
                if (tab === 'timeline') this.updateTimeline();
                else if (tab === 'photos') this.updatePhotoGrid();
            },

            startLongPress(status) {
                this.longPressTimer = setTimeout(() => {
                    this.changeStatus(status);
                    this.showToast('é€€ç¤¾ã—ã¾ã—ãŸ', 'success');
                }, 700);
            },
            endLongPress() { if (this.longPressTimer) { clearTimeout(this.longPressTimer); this.longPressTimer = null; } },

            changeStatus(newStatus) {
                if (this.buttonLocked) return;
                if (this.currentStatus === newStatus) { this.showToast('åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã¯å¤‰æ›´ã§ãã¾ã›ã‚“', 'error'); return; }

                // ç›´å‰1åˆ†æœªæº€ãƒã‚§ãƒƒã‚¯
                if (this.currentSegment && this.statusStartTime) {
                    const duration = Date.now() - this.statusStartTime;
                    if (duration < 60000) {
                        if (!confirm('ç›´å‰ã®åŒºé–“ãŒ1åˆ†æœªæº€ã§ã™ã€‚æœ¬å½“ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ')) return;
                    }
                }

                // ä¸€æ™‚ãƒ­ãƒƒã‚¯
                this.buttonLocked = true;
                document.querySelectorAll('.status-btn').forEach(btn => btn.classList.add('locked'));
                setTimeout(() => {
                    this.buttonLocked = false;
                    document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('locked'));
                }, 800);

                // ç¾åœ¨åŒºé–“çµ‚äº†
                if (this.currentSegment) this.currentSegment.end_at = new Date().toISOString();

                // Undoç”¨ä¿å­˜
                this.lastAction = { type: 'status_change', oldStatus: this.currentStatus, oldSegment: this.currentSegment, timestamp: Date.now() };

                // æ–°è¦åŒºé–“
                const newSegment = { id: `seg${Date.now()}`, status: newStatus, start_at: new Date().toISOString(), end_at: null, loc: this.generateRandomLocation(), source: 'manual' };
                this.data.timeline.push(newSegment);
                this.currentSegment = newSegment;
                this.currentStatus = newStatus;
                this.statusStartTime = Date.now();

                this.saveData();
                this.updateUI();
                this.showToast(`${newStatus}ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, 'undo');
            },

            undo() {
                if (!this.lastAction || Date.now() - this.lastAction.timestamp > 5000) return;
                if (this.lastAction.type === 'status_change') {
                    this.data.timeline.pop();
                    this.currentStatus = this.lastAction.oldStatus;
                    this.currentSegment = this.lastAction.oldSegment;
                    if (this.currentSegment) {
                        this.currentSegment.end_at = null;
                        this.statusStartTime = new Date(this.currentSegment.start_at).getTime();
                    } else {
                        this.statusStartTime = null;
                    }
                    this.saveData();
                    this.updateUI();
                    this.showToast('å…ƒã«æˆ»ã—ã¾ã—ãŸ', 'success');
                    this.lastAction = null;
                }
            },

            generateRandomLocation() {
                const baseLat = 33.5902;
                const baseLon = 130.4017;
                const offset = 0.01;
                return { lat: baseLat + (Math.random() - 0.5) * offset, lon: baseLon + (Math.random() - 0.5) * offset };
            },

            startAutoMove() {
                this.autoMoveInterval = setInterval(() => {
                    if (this.currentStatus && this.currentStatus !== 'ç§»å‹•' && this.currentStatus !== 'é€€ç¤¾') {
                        if (this.currentSegment) this.currentSegment.end_at = new Date().toISOString();
                        const moveSegment = { id: `seg${Date.now()}`, status: 'ç§»å‹•', start_at: new Date().toISOString(), end_at: new Date(Date.now() + 5000).toISOString(), loc: this.generateRandomLocation(), source: 'auto' };
                        this.data.timeline.push(moveSegment);
                        setTimeout(() => {
                            const resumeSegment = { id: `seg${Date.now()}`, status: this.currentStatus, start_at: new Date().toISOString(), end_at: null, loc: this.generateRandomLocation(), source: 'auto' };
                            this.data.timeline.push(resumeSegment);
                            this.currentSegment = resumeSegment;
                            this.statusStartTime = Date.now();
                            this.saveData();
                            this.updateUI();
                        }, 5000);
                        this.saveData();
                        this.updateUI();
                        this.showToast('è‡ªå‹•ç§»å‹•ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸ', 'info');
                    }
                }, 20000);
            },
            stopAutoMove() { if (this.autoMoveInterval) { clearInterval(this.autoMoveInterval); this.autoMoveInterval = null; } },

            startElapsedTimer() {
                setInterval(() => {
                    const el = document.getElementById('elapsed-time');
                    if (!el) return;
                    if (this.statusStartTime) {
                        const elapsed = Date.now() - this.statusStartTime;
                        const hours = Math.floor(elapsed / 3600000);
                        const minutes = Math.floor((elapsed % 3600000) / 60000);
                        const seconds = Math.floor((elapsed % 60000) / 1000);
                        el.textContent = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                    } else {
                        el.textContent = '00:00:00';
                    }
                }, 1000);
            },

            updateUI() {
                document.getElementById('current-status').textContent = this.currentStatus || 'æœªé–‹å§‹';
                this.updateRecentTimeline();
                document.getElementById('send-status').textContent = `å¾…æ©Ÿ: ${this.data.queue.pending} / é€ä¿¡æ¸ˆ: ${this.data.timeline.length}`;
                Object.keys(this.data.settings).forEach(key => {
                    const toggle = document.querySelector(`.toggle[data-setting="${key}"]`);
                    if (toggle) toggle.classList.toggle('active', this.data.settings[key]);
                });
            },

            updateRecentTimeline() {
                const recentList = document.getElementById('recent-timeline');
                const recent = this.data.timeline.slice(-3).reverse();
                recentList.innerHTML = recent.map(seg => `
                    <div class="timeline-card">
                        <span class="status-badge">${seg.status}</span>
                        <div class="time-info">${new Date(seg.start_at).toLocaleTimeString('ja-JP')} - ${seg.end_at ? new Date(seg.end_at).toLocaleTimeString('ja-JP') : 'é€²è¡Œä¸­'}</div>
                        ${seg.source === 'auto' ? '<small>ï¼ˆè‡ªå‹•ï¼‰</small>' : ''}
                    </div>
                `).join('');
            },

            updateTimeline() {
                const list = document.getElementById('timeline-list');
                const todaySegments = this.data.timeline.filter(seg => seg.start_at.startsWith(this.currentDate));
                list.innerHTML = todaySegments.map(seg => `
                    <div class="timeline-card">
                        <span class="status-badge">${seg.status}</span>
                        <button class="edit-btn" onclick="app.openEditModal('${seg.id}')">âœ</button>
                        <div class="time-info">é–‹å§‹: ${new Date(seg.start_at).toLocaleTimeString('ja-JP')}</div>
                        ${seg.end_at ? `
                            <div class="time-info">çµ‚äº†: ${new Date(seg.end_at).toLocaleTimeString('ja-JP')}</div>
                            <div class="time-info">æ‰€è¦: ${this.formatDuration(seg.start_at, seg.end_at)}</div>
                        ` : '<div class="time-info">é€²è¡Œä¸­...</div>'}
                        <div class="time-info">${seg.source === 'auto' ? 'è‡ªå‹•è¨˜éŒ²' : 'æ‰‹å‹•è¨˜éŒ²'}</div>
                    </div>
                `).join('');
                document.getElementById('current-date').textContent = this.currentDate;
            },

            formatDuration(start, end) {
                const duration = new Date(end) - new Date(start);
                const hours = Math.floor(duration / 3600000);
                const minutes = Math.floor((duration % 3600000) / 60000);
                return `${hours}æ™‚é–“${minutes}åˆ†`;
            },

            changeDate(direction) {
                const date = new Date(this.currentDate);
                date.setDate(date.getDate() + direction);
                this.currentDate = date.toISOString().split('T')[0];
                this.updateTimeline();
            },

            openEditModal(segmentId) {
                const segment = this.data.timeline.find(s => s.id === segmentId);
                if (!segment) return;
                this.editingSegment = segment;
                document.getElementById('start-time-input').value = segment.start_at.slice(0, 16);
                document.getElementById('end-time-input').value = segment.end_at ? segment.end_at.slice(0, 16) : '';
                document.getElementById('edit-modal').classList.add('active');
            },
            closeModal() { document.getElementById('edit-modal').classList.remove('active'); this.editingSegment = null; },

            saveTimeEdit() {
                if (!this.editingSegment) return;
                const startTime = document.getElementById('start-time-input').value;
                const endTime = document.getElementById('end-time-input').value;
                if (endTime && new Date(endTime) <= new Date(startTime)) { this.showToast('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„', 'error'); return; }
                this.editingSegment.start_at = new Date(startTime).toISOString();
                if (endTime) this.editingSegment.end_at = new Date(endTime).toISOString();
                this.saveData();
                this.updateTimeline();
                this.closeModal();
                this.showToast('æ™‚åˆ»ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            },

            addPhoto() {
                if (!this.currentStatus || ['å‡ºç¤¾', 'é€€ç¤¾'].includes(this.currentStatus)) { this.showToast('ä½œæ¥­ãƒ»å¾…æ©Ÿãƒ»ç§»å‹•ãƒ»ä¼‘æ†©ä¸­ã«å†™çœŸã‚’è¿½åŠ ã§ãã¾ã™', 'error'); return; }
                document.getElementById('photo-input').click();
            },

            handlePhotoUpload(event) {
                const files = event.target.files;
                if (!files.length) return;
                const status = this.currentStatus;
                if (!this.data.photos[status]) this.data.photos[status] = [];
                if (this.data.photos[status].length >= 5) { this.showToast('å†™çœŸã¯æœ€å¤§5æšã¾ã§ã§ã™', 'error'); return; }
                Array.from(files).forEach(file => {
                    if (this.data.photos[status].length >= 5) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.data.photos[status].push({ url: e.target.result, taken_at: new Date().toISOString() });
                        this.saveData();
                        this.updatePhotoGrid();
                        this.showToast('å†™çœŸã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                    };
                    reader.readAsDataURL(file);
                });
            },

            updatePhotoGrid() {
                const grid = document.getElementById('photo-grid');
                const photos = this.data.photos[this.currentPhotoStatus] || [];
                let html = '';
                photos.forEach(photo => { html += `<div class="photo-item"><img src="${photo.url}" alt="Photo"></div>`; });
                if (photos.length < 5) html += `<div class=\"photo-item add-photo\" onclick=\"document.getElementById('photo-input').click()\">â•</div>`;
                grid.innerHTML = html;
            },

            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type === 'undo' ? 'undo' : ''}`;
                if (type === 'undo') toast.onclick = () => this.undo();
                toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); toast.onclick = null; }, 3000);
            }
        };

        document.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>
